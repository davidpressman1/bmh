<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BMH | Bais Medrash of Haverstraw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="noise"></div>

  <header class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="brand-mark">
          <img src="https://www.kollect.live/bmh/wp-content/uploads/2024/03/bmh-logo.png"
               alt="BMH logo" />
        </div>
        <div>
          <div class="brand-text-main">Bais Medrash of Haverstraw</div>
          <div class="brand-text-sub">Warm minyanim in the heart of Haverstraw, NY</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="#schedule" class="active">Schedule</a>
        <a href="#shabbos">Shabbos</a>
        <a href="#info">Info</a>
        <a href="https://bmofhaverstraw.org/zmanim">Haverstraw Zmanim</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-copy">
        <h1>Bais Medrash of Haverstraw</h1>
        <p class="hero-tagline">
          Weekday and Shabbos times adjust automatically weekly.
        </p>
        <div class="hero-meta">
          <div class="pill">
            <span class="pill-dot"></span>
            <span>Today’s weekday Mincha/Maariv:
              <span id="heroWeekdayMincha" class="dynamic-time">Loading…</span>
            </span>
          </div>
          <div class="pill">
            <span>Shabbos Mincha:
              <span id="heroShabbosMincha" class="dynamic-time">Loading…</span>
            </span>
          </div>
          <div class="pill">
            <span>Shabbos Maariv:
              <span id="heroShabbosMaariv" class="dynamic-time">Loading…</span>
            </span>
          </div>
        </div>
      </div>

      <aside class="hero-card" aria-label="This week at a glance">
        <div class="hero-card-inner">
          <div class="hero-card-title">This Week at BMH</div>
          <div class="hero-card-time">
            <span id="heroPrimaryLabel">Weekday Minyanim</span>
          </div>
          <div class="hero-card-sub">
            Based on the earliest weekday sunset in Mt Ivy, NY for this week.
          </div>

          <div class="hero-card-grid">
            <div class="hero-mini">
              <div class="hero-mini-label">Mincha/Maariv (Sun–Thu)</div>
              <div class="hero-mini-value" id="weekdayMinchaMaariv">Loading…</div>
            </div>
            <div class="hero-mini">
              <div class="hero-mini-label">Regular Maariv (Weeknights)</div>
              <div class="hero-mini-value">
                8:15&nbsp;PM &middot; 9:45&nbsp;PM
              </div>
            </div>
          </div>

          <div class="hero-card-grid" style="margin-top: 10px;">
            <div class="hero-mini">
              <div class="hero-mini-label">Shacharis (Mon–Fri)</div>
              <div class="hero-mini-value">6:25&nbsp;AM</div>
            </div>
            <div class="hero-mini">
              <div class="hero-mini-label">Shacharis (Sun)</div>
              <div class="hero-mini-value">7:00&nbsp;AM &middot; 8:30&nbsp;AM</div>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <section class="section" id="schedule">
      <div class="section-header">
        <div class="section-title">Weekday Schedule</div>
        <div class="section-subtitle">All times local to Mt Ivy, NY (America/New_York)</div>
      </div>

      <div class="grid">
        <article class="card">
          <div class="card-label">Shacharis</div>
          <div class="card-main">Monday &ndash; Friday</div>
          <div class="card-times">
            Shacharis: <strong>6:25&nbsp;AM</strong>
          </div>
          <div class="chip-row">
            <span class="chip">Vasikin-friendly start</span>
          </div>
        </article>

        <article class="card">
          <div class="card-label">Shacharis</div>
          <div class="card-main">Sunday</div>
          <div class="card-times">
            Early minyan: <strong>7:00&nbsp;AM</strong><br />
            Second minyan: <strong>8:30&nbsp;AM</strong>
          </div>
          <div class="chip-row">
            <span class="chip">Two Sunday options</span>
          </div>
        </article>

        <article class="card">
          <div class="card-label">Mincha &amp; Maariv</div>
          <div class="card-main">Sun &ndash; Thu</div>
          <div class="card-times">
            Mincha/Maariv: <span id="weekdayMinchaMaarivCard" class="dynamic-time">Loading…</span><br />
            <span class="small-note">15 minutes before the earliest weekday shkiya (Mon–Fri) of this week.</span>
          </div>
          <div class="chip-row">
            <span class="chip chip-accent">Auto-adjusts with sunset</span>
          </div>
        </article>

        <article class="card">
          <div class="card-label">Regular Maariv</div>
          <div class="card-main">Weeknights</div>
          <div class="card-times">
            First Maariv: <strong>8:15&nbsp;PM</strong><br />
            Second Maariv: <strong>9:45&nbsp;PM</strong>
          </div>
          <div class="chip-row">
            <span class="chip">All week long</span>
          </div>
        </article>
      </div>
    </section>

    <section class="section" id="shabbos">
      <div class="section-header">
        <div class="section-title">Shabbos Schedule</div>
        <div class="section-subtitle">Shabbos times update weekly from sunset in Mt Ivy</div>
      </div>

      <div class="grid">
        <article class="card">
          <div class="card-label">Shacharis</div>
          <div class="card-main">Shabbos Morning</div>
          <div class="card-times">
            Shacharis: <strong>9:00&nbsp;AM</strong>
          </div>
          <div class="chip-row">
            <span class="chip">Shabbos day minyan</span>
          </div>
        </article>

        <article class="card">
          <div class="card-label">Mincha</div>
          <div class="card-main">Erev &amp; Daytime Shabbos</div>
          <div class="card-times">
            Erev Shabbos Mincha:
            <span id="erevShabbosMinchaTime" class="dynamic-time">Loading…</span><br />
            Shabbos Mincha:
            <span id="shabbosMinchaTime" class="dynamic-time">Loading…</span><br />
            <span class="small-note">
              Erev Shabbos: 15 minutes before sunset. Shabbos day: 45 minutes before sunset.
            </span>
          </div>
        </article>

        <article class="card">
          <div class="card-label">Maariv</div>
          <div class="card-main">Motzaei Shabbos</div>
          <div class="card-times">
            Maariv: <span id="shabbosMaarivTime" class="dynamic-time">Loading…</span><br />
            <span class="small-note">50 minutes after Shabbos sunset.</span>
          </div>
        </article>
      </div>
    </section>

    <section class="section" id="info">
      <div class="section-header">
        <div class="section-title">Kehilla Info</div>
        <div class="section-subtitle">Bais Medrash of Haverstraw &middot; Mt Ivy, NY</div>
      </div>

      <div class="grid">
        <article class="card">
          <div class="card-label">Location</div>
          <div class="card-main">Mt Ivy, New York</div>
          <div class="card-times">
            All zmanim are calculated using precise coordinates near Mt Ivy, NY and the America/New_York time zone.
          </div>
          <div class="small-note">
            Times are approximate halachic guidance; always follow your Rav for psak.
          </div>
        </article>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-left">
      &copy; <span id="year"></span> Bais Medrash of Haverstraw (BMH). All rights reserved.
    </div>
    <div class="footer-right">
      Sunset calculations based on the NOAA solar formula and local calibration.
    </div>
  </footer>

<script>
  // Exact coordinates for BMH – Mt Ivy, NY
  const LAT = 41.19392515448243;
  const LNG = -74.02504208449552;
  const ZENITH_DEG = 90.0;

  // Calibration: this Motzaei Shabbos Maariv was at 5:17 PM,
  // defined as 50 minutes after shkiya.
  const CALIBRATION_ENABLED = true;
  const REFERENCE_SHABBOS = "2025-12-06";
  const REFERENCE_MOTZAEI_MAARIV = "17:17";
  const REFERENCE_MAARIV_OFFSET_MIN = 50;

  let CAL_OFFSET_MS = 0;

  function toDateParts(date) {
    const d = new Date(date);
    return {
      year: d.getFullYear(),
      month: d.getMonth(),
      day: d.getDate()
    };
  }

  function dayOfYear(date) {
    const d = new Date(date);
    const start = new Date(d.getFullYear(), 0, 0);
    const diff = d - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  // NOAA solar calculator algorithm – sunset (UT hours) with configurable zenith
  function noaaSunsetUT(date, latDeg, lngDeg, zenithDeg) {
    const N = dayOfYear(date);
    const lngHour = lngDeg / 15.0;

    // Approximate time for sunset
    const t = N + ((18 - lngHour) / 24.0);

    const M = (0.9856 * t) - 3.289;

    const sin = x => Math.sin(x * Math.PI / 180);
    const cos = x => Math.cos(x * Math.PI / 180);
    const tan = x => Math.tan(x * Math.PI / 180);

    let L = M + (1.916 * sin(M)) + (0.020 * sin(2 * M)) + 282.634;
    L = ((L % 360) + 360) % 360;

    let RA = Math.atan(0.91764 * tan(L)) * 180 / Math.PI;
    RA = ((RA % 360) + 360) % 360;

    const Lquadrant = Math.floor(L / 90) * 90;
    const RAquadrant = Math.floor(RA / 90) * 90;
    RA = RA + (Lquadrant - RAquadrant);
    RA /= 15.0;

    const sinDec = 0.39782 * sin(L);
    const cosDec = Math.cos(Math.asin(sinDec));

    const cosH = (cos(zenithDeg) - (sinDec * sin(LAT))) / (cosDec * cos(LAT));

    if (cosH < -1 || cosH > 1) {
      return null;
    }

    let H = Math.acos(cosH) * 180 / Math.PI;
    H = H / 15.0;

    const T = H + RA - (0.06571 * t) - 6.622;

    let UT = T - lngHour;
    UT = ((UT % 24) + 24) % 24;
    return UT;
  }

  function getNoaaSunsetDateRaw(date, latDeg, lngDeg, zenithDeg) {
    const { year, month, day } = toDateParts(date);
    const utHours = noaaSunsetUT(new Date(year, month, day), latDeg, lngDeg, zenithDeg);
    if (utHours == null) return null;

    const hours = Math.floor(utHours);
    const minutes = Math.round((utHours - hours) * 60);

    const baseUTC = Date.UTC(year, month, day, 0, 0, 0);
    const sunsetUTC = new Date(baseUTC + (hours * 60 + minutes) * 60 * 1000);
    return sunsetUTC;
  }

  function getSunsetWithCalibration(date) {
    const raw = getNoaaSunsetDateRaw(date, LAT, LNG, ZENITH_DEG);
    if (!raw) return null;
    if (!CALIBRATION_ENABLED || !CAL_OFFSET_MS) return raw;
    return new Date(raw.getTime() + CAL_OFFSET_MS);
  }

  function formatTimeLocal(date) {
    return date.toLocaleTimeString("en-US", {
      hour: "numeric",
      minute: "2-digit"
    });
  }

  function getMondayOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(12, 0, 0, 0);
    return d;
  }

  function getComingShabbos(fromDate) {
    const d = new Date(fromDate);
    let day = d.getDay();
    let diff = (6 - day + 7) % 7;
    if (diff === 0 && d.getHours() >= 18) {
      diff = 7;
    }
    d.setDate(d.getDate() + diff);
    d.setHours(12, 0, 0, 0);
    return d;
  }

  function parseLocalTimeOnDate(dateString, timeStr) {
    const [h, m] = timeStr.split(":").map(Number);
    const d = new Date(dateString + "T00:00:00");
    d.setHours(h, m, 0, 0);
    return d;
  }

  function computeCalibrationOffsetMs() {
    if (!CALIBRATION_ENABLED) return 0;

    const shabbosDate = new Date(REFERENCE_SHABBOS + "T12:00:00");
    const computedSunset = getNoaaSunsetDateRaw(shabbosDate, LAT, LNG, ZENITH_DEG);
    if (!computedSunset) return 0;

    const maarivActual = parseLocalTimeOnDate(REFERENCE_SHABBOS, REFERENCE_MOTZAEI_MAARIV);
    const shkiyahActual = new Date(maarivActual.getTime() - REFERENCE_MAARIV_OFFSET_MIN * 60 * 1000);

    const offsetMs = shkiyahActual.getTime() - computedSunset.getTime();
    return offsetMs;
  }

  async function updateWeekdayMinchaMaariv() {
    const today = new Date();
    const monday = getMondayOfWeek(today);
    const sunsets = [];

    // Mon–Fri sunset (with calibration)
    for (let i = 0; i < 5; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      const sunset = getSunsetWithCalibration(d);
      if (sunset) sunsets.push(sunset);
    }

    try {
      if (!sunsets.length) throw new Error("No sunsets computed");

      // earliest weekday sunset
      let earliest = sunsets[0];
      for (const s of sunsets) {
        if (s.getTime() < earliest.getTime()) earliest = s;
      }

      // Mincha/Maariv = 15 minutes before shkiya
      const minchaTime = new Date(earliest.getTime() - 15 * 60 * 1000);
      const timeStr = formatTimeLocal(minchaTime);

      const elMain = document.getElementById("weekdayMinchaMaariv");
      const elCard = document.getElementById("weekdayMinchaMaarivCard");
      const elHero = document.getElementById("heroWeekdayMincha");

      if (elMain) elMain.textContent = timeStr;
      if (elCard) elCard.textContent = timeStr;
      if (elHero) elHero.textContent = timeStr;
    } catch (e) {
      console.error(e);
      const fallback = "Check shul board";
      ["weekdayMinchaMaariv", "weekdayMinchaMaarivCard", "heroWeekdayMincha"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = fallback;
        });
    }
  }

  async function updateShabbosTimes() {
    const today = new Date();
    const shabbos = getComingShabbos(today);

    try {
      const sunset = getSunsetWithCalibration(shabbos);
      if (!sunset) throw new Error("No Shabbos sunset");

      // Erev Shabbos Mincha: 15 minutes before shkiya
      const erevMincha = new Date(sunset.getTime() - 15 * 60 * 1000);
      // Shabbos day Mincha: 45 minutes before shkiya
      const shabbosMincha = new Date(sunset.getTime() - 45 * 60 * 1000);
      // Motzaei Shabbos Maariv: 50 minutes after shkiya
      const maariv = new Date(sunset.getTime() + 50 * 60 * 1000);

      const erevMinchaStr = formatTimeLocal(erevMincha);
      const shabbosMinchaStr = formatTimeLocal(shabbosMincha);
      const maarivStr = formatTimeLocal(maariv);

      const erevMinchaEl = document.getElementById("erevShabbosMinchaTime");
      const shMincha = document.getElementById("shabbosMinchaTime");
      const shMaariv = document.getElementById("shabbosMaarivTime");
      const heroMincha = document.getElementById("heroShabbosMincha");
      const heroMaariv = document.getElementById("heroShabbosMaariv");

      if (erevMinchaEl) erevMinchaEl.textContent = erevMinchaStr;
      if (shMincha) shMincha.textContent = shabbosMinchaStr;
      if (shMaariv) shMaariv.textContent = maarivStr;
      if (heroMincha) heroMincha.textContent = shabbosMinchaStr; // hero shows Shabbos-day Mincha
      if (heroMaariv) heroMaariv.textContent = maarivStr;
    } catch (e) {
      console.error(e);
      const fallback = "See local listing";
      [
        "erevShabbosMinchaTime",
        "shabbosMinchaTime",
        "shabbosMaarivTime",
        "heroShabbosMincha",
        "heroShabbosMaariv"
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = fallback;
      });
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    CAL_OFFSET_MS = computeCalibrationOffsetMs();
    updateWeekdayMinchaMaariv();
    updateShabbosTimes();
  });
</script>
</body>
</html>
