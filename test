import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import {
 getAuth,
 signInWithCustomToken,
 signInAnonymously,
 onAuthStateChanged,
 signOut
} from 'firebase/auth';
import {
 getFirestore,
 doc,
 setDoc,
 getDoc,
 onSnapshot,
 collection
} from 'firebase/firestore';
import {
 Calendar,
 Clock,
 Settings,
 LogOut,
 LogIn,
 Save,
 ChevronRight,
 Sun,
 Moon,
 Info
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'shul-zmanim-app';

// --- Default Data ---
const DEFAULT_ZMANIM = {
 shacharis: "07:00 AM",
 mincha: "04:30 PM",
 maariv: "08:00 PM",
 candleLighting: "04:15 PM",
 motzeiShabbos: "05:20 PM",
 dafYomi: "06:15 AM",
 announcement: "Welcome to our Shul! Please join us for our upcoming community Kiddush."
};

export default function App() {
 const [user, setUser] = useState(null);
 const [view, setView] = useState('public'); // 'public' | 'admin' | 'login'
 const [zmanim, setZmanim] = useState(DEFAULT_ZMANIM);
 const [loading, setLoading] = useState(true);
 const [authError, setAuthError] = useState('');
 const [saveStatus, setSaveStatus] = useState('');

 // 1. Auth Initialization
 useEffect(() => {
   const initAuth = async () => {
     try {
       if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
         await signInWithCustomToken(auth, __initial_auth_token);
       } else {
         // We use anonymous for public read, but logic handles admin vs public views
         await signInAnonymously(auth);
       }
     } catch (err) {
       console.error("Auth error:", err);
     }
   };
   initAuth();
   const unsubscribe = onAuthStateChanged(auth, (u) => {
     setUser(u);
     setLoading(false);
   });
   return () => unsubscribe();
 }, []);

 // 2. Data Synchronization
 useEffect(() => {
   if (!user) return;

   // Use a specific doc for shul settings
   const zmanimDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'shul_settings');

   const unsubscribe = onSnapshot(zmanimDocRef, (docSnap) => {
     if (docSnap.exists()) {
       setZmanim(docSnap.data());
     } else {
       // Initialize if empty
       setDoc(zmanimDocRef, DEFAULT_ZMANIM);
     }
   }, (error) => {
     console.error("Firestore error:", error);
   });

   return () => unsubscribe();
 }, [user]);

 // Handle Save
 const handleSaveZmanim = async (e) => {
   e.preventDefault();
   if (!user || user.isAnonymous) {
       setSaveStatus("You must be signed in as an admin to save.");
       return;
   }

   setSaveStatus("Saving...");
   try {
     const zmanimDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'shul_settings');
     await setDoc(zmanimDocRef, zmanim);
     setSaveStatus("Saved successfully!");
     setTimeout(() => setSaveStatus(""), 3000);
   } catch (err) {
     setSaveStatus("Error saving changes.");
     console.error(err);
   }
 };

 // Login Simulation
 // Note: In a real scenario, __initial_auth_token or a specific provider is used.
 // For this demo, we use a simple toggle to "Admin Mode" UI if they have a real account.
 const handleLogin = (e) => {
   e.preventDefault();
   // Logic: Real login would happen via Firebase Auth.
   // Here we show the UI intended for an admin.
   setView('admin');
 };

 if (loading) {
   return (
     <div className="min-h-screen flex items-center justify-center bg-slate-50">
       <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
     </div>
   );
 }

 return (
   <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
     {/* Navigation */}
     <nav className="bg-indigo-900 text-white shadow-lg">
       <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
         <div
           className="flex items-center space-x-2 cursor-pointer"
           onClick={() => setView('public')}
         >
           <div className="bg-white p-1.5 rounded-lg text-indigo-900">
             <Calendar size={24} />
           </div>
           <h1 className="text-xl font-bold tracking-tight">Congregation Beth Israel</h1>
         </div>
         
         <div>
           {view === 'admin' ? (
             <button
               onClick={() => setView('public')}
               className="flex items-center space-x-2 bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg transition"
             >
               <LogOut size={18} />
               <span>Exit Admin</span>
             </button>
           ) : (
             <button
               onClick={() => setView('login')}
               className="flex items-center space-x-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition"
             >
               <LogIn size={18} />
               <span>Admin Login</span>
             </button>
           )}
         </div>
       </div>
     </nav>

     {/* Main Content */}
     <main className="max-w-4xl mx-auto px-4 py-8">
       
       {view === 'public' && (
         <div className="space-y-6">
           {/* Announcement Banner */}
           {zmanim.announcement && (
             <div className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg flex items-start space-x-3">
               <Info className="text-amber-500 mt-0.5" size={20} />
               <p className="text-amber-800 text-sm md:text-base font-medium">
                 {zmanim.announcement}
               </p>
             </div>
           )}

           <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             {/* Daily Times */}
             <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
               <div className="bg-indigo-50 px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                 <h2 className="font-bold text-indigo-900 flex items-center gap-2">
                   <Sun size={20} /> Weekday Zmanim
                 </h2>
               </div>
               <div className="p-6 space-y-4">
                 <ZmanRow label="Daf Yomi" time={zmanim.dafYomi} />
                 <ZmanRow label="Shacharis" time={zmanim.shacharis} />
                 <ZmanRow label="Mincha" time={zmanim.mincha} />
                 <ZmanRow label="Maariv" time={zmanim.maariv} />
               </div>
             </div>

             {/* Shabbos Times */}
             <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
               <div className="bg-indigo-900/5 px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                 <h2 className="font-bold text-indigo-900 flex items-center gap-2">
                   <Moon size={20} /> Shabbos Kodesh
                 </h2>
               </div>
               <div className="p-6 space-y-4">
                 <ZmanRow label="Candle Lighting" time={zmanim.candleLighting} highlight />
                 <ZmanRow label="Motzei Shabbos" time={zmanim.motzeiShabbos} />
               </div>
             </div>
           </div>
         </div>
       )}

       {view === 'login' && (
         <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-200 mt-12">
           <h2 className="text-2xl font-bold mb-6 text-center text-slate-800">Admin Access</h2>
           <form onSubmit={handleLogin} className="space-y-4">
             <div>
               <label className="block text-sm font-medium text-slate-700 mb-1">Email</label>
               <input
                 type="email"
                 required
                 placeholder="admin@shulname.org"
                 className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
               />
             </div>
             <div>
               <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
               <input
                 type="password"
                 required
                 placeholder="••••••••"
                 className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
               />
             </div>
             <button
               type="submit"
               className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition"
             >
               Log In
             </button>
             <button
               type="button"
               onClick={() => setView('public')}
               className="w-full text-slate-500 text-sm hover:underline"
             >
               Cancel
             </button>
           </form>
         </div>
       )}

       {view === 'admin' && (
         <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
           <div className="bg-slate-800 px-6 py-4 text-white flex justify-between items-center">
             <h2 className="font-bold text-lg flex items-center gap-2">
               <Settings size={20} /> Update Shul Zmanim
             </h2>
             {saveStatus && (
               <span className="text-sm bg-slate-700 px-3 py-1 rounded-full animate-pulse">
                 {saveStatus}
               </span>
             )}
           </div>
           <form onSubmit={handleSaveZmanim} className="p-8 space-y-6">
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
               <AdminInput
                 label="Shacharis"
                 value={zmanim.shacharis}
                 onChange={(v) => setZmanim({...zmanim, shacharis: v})}
               />
               <AdminInput
                 label="Mincha"
                 value={zmanim.mincha}
                 onChange={(v) => setZmanim({...zmanim, mincha: v})}
               />
               <AdminInput
                 label="Maariv"
                 value={zmanim.maariv}
                 onChange={(v) => setZmanim({...zmanim, maariv: v})}
               />
               <AdminInput
                 label="Daf Yomi"
                 value={zmanim.dafYomi}
                 onChange={(v) => setZmanim({...zmanim, dafYomi: v})}
               />
               <AdminInput
                 label="Candle Lighting"
                 value={zmanim.candleLighting}
                 onChange={(v) => setZmanim({...zmanim, candleLighting: v})}
               />
               <AdminInput
                 label="Motzei Shabbos"
                 value={zmanim.motzeiShabbos}
                 onChange={(v) => setZmanim({...zmanim, motzeiShabbos: v})}
               />
             </div>
             
             <div>
               <label className="block text-sm font-bold text-slate-700 mb-2">Special Announcement</label>
               <textarea
                 value={zmanim.announcement}
                 onChange={(e) => setZmanim({...zmanim, announcement: e.target.value})}
                 rows="3"
                 className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                 placeholder="e.g. Shul Kiddush this week..."
               ></textarea>
             </div>

             <div className="pt-4 border-t flex justify-end">
               <button
                 type="submit"
                 disabled={user?.isAnonymous}
                 className={`flex items-center space-x-2 px-8 py-3 rounded-xl font-bold transition shadow-lg ${
                   user?.isAnonymous
                   ? "bg-slate-300 cursor-not-allowed text-slate-500"
                   : "bg-indigo-600 hover:bg-indigo-700 text-white"
                 }`}
               >
                 <Save size={20} />
                 <span>{user?.isAnonymous ? "Login Required to Save" : "Save Changes"}</span>
               </button>
             </div>
           </form>
         </div>
       )}
     </main>

     <footer className="text-center py-8 text-slate-400 text-sm">
       <p>© 2024 Congregation Beth Israel • Zmanim Portal</p>
     </footer>
   </div>
 );
}

function ZmanRow({ label, time, highlight = false }) {
 return (
   <div className={`flex justify-between items-center py-3 border-b border-slate-100 last:border-0 ${highlight ? 'text-indigo-600 font-semibold' : ''}`}>
     <span className="text-slate-600 font-medium">{label}</span>
     <div className="flex items-center space-x-2">
       <Clock size={14} className="text-slate-400" />
       <span className="text-slate-900 tabular-nums">{time}</span>
     </div>
   </div>
 );
}

function AdminInput({ label, value, onChange }) {
 return (
   <div>
     <label className="block text-sm font-bold text-slate-700 mb-1">{label}</label>
     <input
       type="text"
       value={value}
       onChange={(e) => onChange(e.target.value)}
       className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
     />
   </div>
 );
}